

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Advanced Features &mdash; Cardinity Python SDK v1.0.0</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=f9c3a110" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=8d563738"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Migration from Node.js SDK" href="../migration.html" />
    <link rel="prev" title="Error Handling" href="error-handling.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >

          
          
          <a href="../index.html" class="icon icon-home">
            Cardinity Python SDK
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">Quick Start Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../authentication.html">Authentication</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Examples</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html#available-examples">Available Examples</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="basic-payments.html">Basic Payment Processing</a></li>
<li class="toctree-l3"><a class="reference internal" href="recurring-payments.html">Recurring Payments</a></li>
<li class="toctree-l3"><a class="reference internal" href="3ds-authentication.html">3D Secure Authentication</a></li>
<li class="toctree-l3"><a class="reference internal" href="refunds-settlements.html">Refunds and Settlements</a></li>
<li class="toctree-l3"><a class="reference internal" href="error-handling.html">Error Handling</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Advanced Features</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#webhook-integration">Webhook Integration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#payment-links">Payment Links</a></li>
<li class="toctree-l4"><a class="reference internal" href="#batch-payment-processing">Batch Payment Processing</a></li>
<li class="toctree-l4"><a class="reference internal" href="#advanced-authentication">Advanced Authentication</a></li>
<li class="toctree-l4"><a class="reference internal" href="#payment-analytics">Payment Analytics</a></li>
<li class="toctree-l4"><a class="reference internal" href="#complex-payment-workflows">Complex Payment Workflows</a></li>
<li class="toctree-l4"><a class="reference internal" href="#advanced-security-features">Advanced Security Features</a></li>
<li class="toctree-l4"><a class="reference internal" href="#integration-testing">Integration Testing</a></li>
<li class="toctree-l4"><a class="reference internal" href="#performance-optimization">Performance Optimization</a></li>
<li class="toctree-l4"><a class="reference internal" href="#production-deployment">Production Deployment</a></li>
<li class="toctree-l4"><a class="reference internal" href="#next-steps">Next Steps</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#quick-reference">Quick Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#basic-payment-example">Basic Payment Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#recurring-payments-example">Recurring Payments Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#d-secure-authentication-example">3D Secure Authentication Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#refund-processing-example">Refund Processing Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#error-handling-example">Error Handling Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#running-examples">Running Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#integration-patterns">Integration Patterns</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#best-practices">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#next-steps">Next Steps</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#need-help">Need Help?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../migration.html">Migration from Node.js SDK</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2980B9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Cardinity Python SDK</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Examples</a></li>
      <li class="breadcrumb-item active">Advanced Features</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/trendpro/cardinity-python/blob/main/docs/examples/advanced-features.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="advanced-features">
<h1>Advanced Features<a class="headerlink" href="#advanced-features" title="Link to this heading"></a></h1>
<p>This section covers advanced features and integration patterns with the Cardinity Python SDK, including webhooks, payment methods, advanced authentication, and complex payment scenarios.</p>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading"></a></h2>
<p>Advanced features include:</p>
<ol class="arabic simple">
<li><p><strong>Webhook Integration</strong>: Real-time payment notifications</p></li>
<li><p><strong>Payment Methods</strong>: Alternative payment methods beyond cards</p></li>
<li><p><strong>Advanced Authentication</strong>: OAuth and API key management</p></li>
<li><p><strong>Batch Processing</strong>: Handle multiple payments efficiently</p></li>
<li><p><strong>Payment Links</strong>: Generate payment links for customers</p></li>
<li><p><strong>Complex Workflows</strong>: Multi-step payment processes</p></li>
<li><p><strong>Analytics Integration</strong>: Payment data analysis and reporting</p></li>
</ol>
</section>
<section id="webhook-integration">
<h2>Webhook Integration<a class="headerlink" href="#webhook-integration" title="Link to this heading"></a></h2>
<p>Set up webhooks for real-time payment notifications:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Webhook Integration Example</span>

<span class="sd">This example shows how to set up and handle webhooks for payment notifications.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hmac</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cardinity</span><span class="w"> </span><span class="kn">import</span> <span class="n">Cardinity</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># Initialize Cardinity client</span>
<span class="n">cardinity</span> <span class="o">=</span> <span class="n">Cardinity</span><span class="p">(</span>
    <span class="n">consumer_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;CARDINITY_CONSUMER_KEY&quot;</span><span class="p">,</span> <span class="s2">&quot;your_consumer_key_here&quot;</span><span class="p">),</span>
    <span class="n">consumer_secret</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;CARDINITY_CONSUMER_SECRET&quot;</span><span class="p">,</span> <span class="s2">&quot;your_consumer_secret_here&quot;</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Webhook configuration</span>
<span class="n">WEBHOOK_SECRET</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;CARDINITY_WEBHOOK_SECRET&quot;</span><span class="p">,</span> <span class="s2">&quot;your_webhook_secret&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">verify_webhook_signature</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">signature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify webhook signature for security.&quot;&quot;&quot;</span>

    <span class="n">expected_signature</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
        <span class="n">WEBHOOK_SECRET</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span>
        <span class="n">payload</span><span class="p">,</span>
        <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span>
    <span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">hmac</span><span class="o">.</span><span class="n">compare_digest</span><span class="p">(</span><span class="n">signature</span><span class="p">,</span> <span class="n">expected_signature</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/webhooks/cardinity&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">handle_cardinity_webhook</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle incoming Cardinity webhooks.&quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Get raw payload and signature</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;X-Cardinity-Signature&#39;</span><span class="p">)</span>

        <span class="c1"># Verify signature</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_webhook_signature</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">signature</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid signature&#39;</span><span class="p">}),</span> <span class="mi">401</span>

        <span class="c1"># Parse webhook data</span>
        <span class="n">webhook_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

        <span class="c1"># Process webhook based on event type</span>
        <span class="n">event_type</span> <span class="o">=</span> <span class="n">webhook_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s1">&#39;payment.approved&#39;</span><span class="p">:</span>
            <span class="n">handle_payment_approved</span><span class="p">(</span><span class="n">webhook_data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s1">&#39;payment.declined&#39;</span><span class="p">:</span>
            <span class="n">handle_payment_declined</span><span class="p">(</span><span class="n">webhook_data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s1">&#39;payment.pending&#39;</span><span class="p">:</span>
            <span class="n">handle_payment_pending</span><span class="p">(</span><span class="n">webhook_data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s1">&#39;refund.approved&#39;</span><span class="p">:</span>
            <span class="n">handle_refund_approved</span><span class="p">(</span><span class="n">webhook_data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s1">&#39;settlement.approved&#39;</span><span class="p">:</span>
            <span class="n">handle_settlement_approved</span><span class="p">(</span><span class="n">webhook_data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown webhook event: </span><span class="si">{</span><span class="n">event_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;processed&#39;</span><span class="p">}),</span> <span class="mi">200</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Webhook processing error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Processing failed&#39;</span><span class="p">}),</span> <span class="mi">500</span>

<span class="k">def</span><span class="w"> </span><span class="nf">handle_payment_approved</span><span class="p">(</span><span class="n">webhook_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle approved payment webhook.&quot;&quot;&quot;</span>

    <span class="n">payment_id</span> <span class="o">=</span> <span class="n">webhook_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
    <span class="n">amount</span> <span class="o">=</span> <span class="n">webhook_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Payment approved: </span><span class="si">{</span><span class="n">payment_id</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Update your database</span>
    <span class="c1"># Send confirmation email</span>
    <span class="c1"># Update order status</span>
    <span class="c1"># Trigger fulfillment process</span>

<span class="k">def</span><span class="w"> </span><span class="nf">handle_payment_declined</span><span class="p">(</span><span class="n">webhook_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle declined payment webhook.&quot;&quot;&quot;</span>

    <span class="n">payment_id</span> <span class="o">=</span> <span class="n">webhook_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
    <span class="n">decline_reason</span> <span class="o">=</span> <span class="n">webhook_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Payment declined: </span><span class="si">{</span><span class="n">payment_id</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">decline_reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Update order status</span>
    <span class="c1"># Send notification to customer</span>
    <span class="c1"># Offer alternative payment methods</span>

<span class="k">def</span><span class="w"> </span><span class="nf">handle_payment_pending</span><span class="p">(</span><span class="n">webhook_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle pending payment webhook (3DS in progress).&quot;&quot;&quot;</span>

    <span class="n">payment_id</span> <span class="o">=</span> <span class="n">webhook_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⏳ Payment pending: </span><span class="si">{</span><span class="n">payment_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Update order status to pending</span>
    <span class="c1"># Notify customer about 3DS requirement</span>

<span class="k">def</span><span class="w"> </span><span class="nf">handle_refund_approved</span><span class="p">(</span><span class="n">webhook_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle approved refund webhook.&quot;&quot;&quot;</span>

    <span class="n">refund_id</span> <span class="o">=</span> <span class="n">webhook_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
    <span class="n">amount</span> <span class="o">=</span> <span class="n">webhook_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;💰 Refund approved: </span><span class="si">{</span><span class="n">refund_id</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Update order status</span>
    <span class="c1"># Send refund confirmation</span>
    <span class="c1"># Update inventory if needed</span>
</pre></div>
</div>
</section>
<section id="payment-links">
<h2>Payment Links<a class="headerlink" href="#payment-links" title="Link to this heading"></a></h2>
<p>Generate payment links for customers:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">create_payment_link</span><span class="p">(</span><span class="n">order_details</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a payment link for customer checkout.&quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">payment_link</span> <span class="o">=</span> <span class="n">cardinity</span><span class="o">.</span><span class="n">create_payment_link</span><span class="p">(</span>
            <span class="n">amount</span><span class="o">=</span><span class="n">order_details</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">],</span>
            <span class="n">currency</span><span class="o">=</span><span class="n">order_details</span><span class="p">[</span><span class="s1">&#39;currency&#39;</span><span class="p">],</span>
            <span class="n">description</span><span class="o">=</span><span class="n">order_details</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">],</span>
            <span class="n">country</span><span class="o">=</span><span class="n">order_details</span><span class="p">[</span><span class="s1">&#39;country&#39;</span><span class="p">],</span>
            <span class="n">order_id</span><span class="o">=</span><span class="n">order_details</span><span class="p">[</span><span class="s1">&#39;order_id&#39;</span><span class="p">],</span>
            <span class="n">return_url</span><span class="o">=</span><span class="n">order_details</span><span class="p">[</span><span class="s1">&#39;return_url&#39;</span><span class="p">],</span>
            <span class="n">callback_url</span><span class="o">=</span><span class="n">order_details</span><span class="p">[</span><span class="s1">&#39;callback_url&#39;</span><span class="p">],</span>
            <span class="c1"># Optional: Set expiration</span>
            <span class="n">expires_at</span><span class="o">=</span><span class="n">order_details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;expires_at&#39;</span><span class="p">),</span>
            <span class="c1"># Optional: Custom styling</span>
            <span class="n">theme</span><span class="o">=</span><span class="n">order_details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;theme&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Payment link created: </span><span class="si">{</span><span class="n">payment_link</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Link URL: </span><span class="si">{</span><span class="n">payment_link</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Expires: </span><span class="si">{</span><span class="n">payment_link</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;expires_at&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;No expiration&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">payment_link</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Payment link creation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">payment_link_workflow</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrate payment link workflow.&quot;&quot;&quot;</span>

    <span class="c1"># Create order</span>
    <span class="n">order</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;order_id&#39;</span><span class="p">:</span> <span class="s1">&#39;ORDER-2023-12345&#39;</span><span class="p">,</span>
        <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="s1">&#39;99.99&#39;</span><span class="p">,</span>
        <span class="s1">&#39;currency&#39;</span><span class="p">:</span> <span class="s1">&#39;EUR&#39;</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Premium Product Purchase&#39;</span><span class="p">,</span>
        <span class="s1">&#39;country&#39;</span><span class="p">:</span> <span class="s1">&#39;LT&#39;</span><span class="p">,</span>
        <span class="s1">&#39;return_url&#39;</span><span class="p">:</span> <span class="s1">&#39;https://your-site.com/payment/success&#39;</span><span class="p">,</span>
        <span class="s1">&#39;callback_url&#39;</span><span class="p">:</span> <span class="s1">&#39;https://your-site.com/webhooks/cardinity&#39;</span><span class="p">,</span>
        <span class="s1">&#39;expires_at&#39;</span><span class="p">:</span> <span class="s1">&#39;2023-12-31T23:59:59Z&#39;</span><span class="p">,</span>
        <span class="s1">&#39;theme&#39;</span><span class="p">:</span> <span class="s1">&#39;modern&#39;</span>
    <span class="p">}</span>

    <span class="c1"># Create payment link</span>
    <span class="n">payment_link</span> <span class="o">=</span> <span class="n">create_payment_link</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">payment_link</span><span class="p">:</span>
        <span class="c1"># Send link to customer (email, SMS, etc.)</span>
        <span class="n">send_payment_link_to_customer</span><span class="p">(</span>
            <span class="n">customer_email</span><span class="o">=</span><span class="s1">&#39;customer@example.com&#39;</span><span class="p">,</span>
            <span class="n">payment_url</span><span class="o">=</span><span class="n">payment_link</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">],</span>
            <span class="n">order_details</span><span class="o">=</span><span class="n">order</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">payment_link</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">send_payment_link_to_customer</span><span class="p">(</span><span class="n">customer_email</span><span class="p">,</span> <span class="n">payment_url</span><span class="p">,</span> <span class="n">order_details</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Send payment link to customer via email.&quot;&quot;&quot;</span>

    <span class="c1"># Email implementation would go here</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📧 Sending payment link to </span><span class="si">{</span><span class="n">customer_email</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Payment URL: </span><span class="si">{</span><span class="n">payment_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Order: </span><span class="si">{</span><span class="n">order_details</span><span class="p">[</span><span class="s1">&#39;order_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="batch-payment-processing">
<h2>Batch Payment Processing<a class="headerlink" href="#batch-payment-processing" title="Link to this heading"></a></h2>
<p>Handle multiple payments efficiently:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">concurrent.futures</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BatchPaymentProcessor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process multiple payments in batches.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cardinity_client</span><span class="p">,</span> <span class="n">max_workers</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cardinity</span> <span class="o">=</span> <span class="n">cardinity_client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_workers</span> <span class="o">=</span> <span class="n">max_workers</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_payment_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payment_requests</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process multiple payments concurrently.&quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🔄 Processing batch of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">payment_requests</span><span class="p">)</span><span class="si">}</span><span class="s2"> payments...&quot;</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_workers</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="c1"># Submit all payment requests</span>
            <span class="n">future_to_request</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_process_single_payment</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span> <span class="n">request</span>
                <span class="k">for</span> <span class="n">request</span> <span class="ow">in</span> <span class="n">payment_requests</span>
            <span class="p">}</span>

            <span class="c1"># Collect results as they complete</span>
            <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">future_to_request</span><span class="p">):</span>
                <span class="n">request</span> <span class="o">=</span> <span class="n">future_to_request</span><span class="p">[</span><span class="n">future</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;request&#39;</span><span class="p">:</span> <span class="n">request</span><span class="p">,</span>
                        <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">,</span>
                        <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;completed&#39;</span>
                    <span class="p">})</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;request&#39;</span><span class="p">:</span> <span class="n">request</span><span class="p">,</span>
                        <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;failed&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="p">})</span>

        <span class="c1"># Summary</span>
        <span class="n">successful</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;completed&#39;</span> <span class="ow">and</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">])</span>
        <span class="n">failed</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">-</span> <span class="n">successful</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Batch processing completed: </span><span class="si">{</span><span class="n">successful</span><span class="si">}</span><span class="s2"> successful, </span><span class="si">{</span><span class="n">failed</span><span class="si">}</span><span class="s2"> failed&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_single_payment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payment_request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process a single payment request.&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">payment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardinity</span><span class="o">.</span><span class="n">create_payment</span><span class="p">(</span><span class="o">**</span><span class="n">payment_request</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">payment</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Payment failed for </span><span class="si">{</span><span class="n">payment_request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;order_id&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">batch_processing_example</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Example of batch payment processing.&quot;&quot;&quot;</span>

    <span class="c1"># Create batch processor</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">BatchPaymentProcessor</span><span class="p">(</span><span class="n">cardinity</span><span class="p">,</span> <span class="n">max_workers</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="c1"># Define payment requests</span>
    <span class="n">payment_requests</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="s1">&#39;25.99&#39;</span><span class="p">,</span>
            <span class="s1">&#39;currency&#39;</span><span class="p">:</span> <span class="s1">&#39;EUR&#39;</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Subscription renewal - Customer A&#39;</span><span class="p">,</span>
            <span class="s1">&#39;country&#39;</span><span class="p">:</span> <span class="s1">&#39;LT&#39;</span><span class="p">,</span>
            <span class="s1">&#39;order_id&#39;</span><span class="p">:</span> <span class="s1">&#39;SUB-001&#39;</span><span class="p">,</span>
            <span class="s1">&#39;payment_instrument&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;pan&#39;</span><span class="p">:</span> <span class="s1">&#39;4111111111111111&#39;</span><span class="p">,</span>
                <span class="s1">&#39;exp_month&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
                <span class="s1">&#39;exp_year&#39;</span><span class="p">:</span> <span class="mi">2025</span><span class="p">,</span>
                <span class="s1">&#39;cvc&#39;</span><span class="p">:</span> <span class="s1">&#39;123&#39;</span><span class="p">,</span>
                <span class="s1">&#39;holder&#39;</span><span class="p">:</span> <span class="s1">&#39;Customer A&#39;</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="s1">&#39;49.99&#39;</span><span class="p">,</span>
            <span class="s1">&#39;currency&#39;</span><span class="p">:</span> <span class="s1">&#39;EUR&#39;</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Subscription renewal - Customer B&#39;</span><span class="p">,</span>
            <span class="s1">&#39;country&#39;</span><span class="p">:</span> <span class="s1">&#39;LT&#39;</span><span class="p">,</span>
            <span class="s1">&#39;order_id&#39;</span><span class="p">:</span> <span class="s1">&#39;SUB-002&#39;</span><span class="p">,</span>
            <span class="s1">&#39;payment_instrument&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;pan&#39;</span><span class="p">:</span> <span class="s1">&#39;5555555555554444&#39;</span><span class="p">,</span>
                <span class="s1">&#39;exp_month&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
                <span class="s1">&#39;exp_year&#39;</span><span class="p">:</span> <span class="mi">2025</span><span class="p">,</span>
                <span class="s1">&#39;cvc&#39;</span><span class="p">:</span> <span class="s1">&#39;456&#39;</span><span class="p">,</span>
                <span class="s1">&#39;holder&#39;</span><span class="p">:</span> <span class="s1">&#39;Customer B&#39;</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="s1">&#39;19.99&#39;</span><span class="p">,</span>
            <span class="s1">&#39;currency&#39;</span><span class="p">:</span> <span class="s1">&#39;EUR&#39;</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Subscription renewal - Customer C&#39;</span><span class="p">,</span>
            <span class="s1">&#39;country&#39;</span><span class="p">:</span> <span class="s1">&#39;LT&#39;</span><span class="p">,</span>
            <span class="s1">&#39;order_id&#39;</span><span class="p">:</span> <span class="s1">&#39;SUB-003&#39;</span><span class="p">,</span>
            <span class="s1">&#39;payment_instrument&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;pan&#39;</span><span class="p">:</span> <span class="s1">&#39;378282246310005&#39;</span><span class="p">,</span>
                <span class="s1">&#39;exp_month&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
                <span class="s1">&#39;exp_year&#39;</span><span class="p">:</span> <span class="mi">2025</span><span class="p">,</span>
                <span class="s1">&#39;cvc&#39;</span><span class="p">:</span> <span class="s1">&#39;1234&#39;</span><span class="p">,</span>
                <span class="s1">&#39;holder&#39;</span><span class="p">:</span> <span class="s1">&#39;Customer C&#39;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">]</span>

    <span class="c1"># Process batch</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_payment_batch</span><span class="p">(</span><span class="n">payment_requests</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span>
</pre></div>
</div>
</section>
<section id="advanced-authentication">
<h2>Advanced Authentication<a class="headerlink" href="#advanced-authentication" title="Link to this heading"></a></h2>
<p>Implement advanced authentication patterns:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AdvancedCardinityAuth</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Advanced authentication patterns for Cardinity.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token_expiry</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_client_with_token_refresh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">consumer_key</span><span class="p">,</span> <span class="n">consumer_secret</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get Cardinity client with automatic token refresh.&quot;&quot;&quot;</span>

        <span class="c1"># Check if we have a valid cached token</span>
        <span class="n">token_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">consumer_key</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">consumer_secret</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">token_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="p">:</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="p">[</span><span class="n">token_key</span><span class="p">]</span>
            <span class="c1"># In a real implementation, check token expiry</span>
            <span class="c1"># For now, assume token is valid</span>
            <span class="k">return</span> <span class="n">Cardinity</span><span class="p">(</span>
                <span class="n">consumer_key</span><span class="o">=</span><span class="n">consumer_key</span><span class="p">,</span>
                <span class="n">consumer_secret</span><span class="o">=</span><span class="n">consumer_secret</span><span class="p">,</span>
                <span class="n">access_token</span><span class="o">=</span><span class="n">token</span>
            <span class="p">)</span>

        <span class="c1"># Create new client (which will generate token)</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">Cardinity</span><span class="p">(</span>
            <span class="n">consumer_key</span><span class="o">=</span><span class="n">consumer_key</span><span class="p">,</span>
            <span class="n">consumer_secret</span><span class="o">=</span><span class="n">consumer_secret</span>
        <span class="p">)</span>

        <span class="c1"># Cache the token (in real implementation, extract from client)</span>
        <span class="c1"># self.tokens[token_key] = client.access_token</span>

        <span class="k">return</span> <span class="n">client</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">multi_account_payment_processing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account_configs</span><span class="p">,</span> <span class="n">payment_request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process payment across multiple merchant accounts.&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">account_name</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">account_configs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🔄 Trying payment with account: </span><span class="si">{</span><span class="n">account_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_client_with_token_refresh</span><span class="p">(</span>
                    <span class="n">config</span><span class="p">[</span><span class="s1">&#39;consumer_key&#39;</span><span class="p">],</span>
                    <span class="n">config</span><span class="p">[</span><span class="s1">&#39;consumer_secret&#39;</span><span class="p">]</span>
                <span class="p">)</span>

                <span class="n">payment</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">create_payment</span><span class="p">(</span><span class="o">**</span><span class="n">payment_request</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">payment</span> <span class="ow">and</span> <span class="n">payment</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;approved&#39;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Payment successful with account: </span><span class="si">{</span><span class="n">account_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="p">{</span>
                        <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="s1">&#39;payment&#39;</span><span class="p">:</span> <span class="n">payment</span><span class="p">,</span>
                        <span class="s1">&#39;account&#39;</span><span class="p">:</span> <span class="n">account_name</span>
                    <span class="p">}</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Payment failed with account </span><span class="si">{</span><span class="n">account_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;All accounts failed&#39;</span>
        <span class="p">}</span>
</pre></div>
</div>
</section>
<section id="payment-analytics">
<h2>Payment Analytics<a class="headerlink" href="#payment-analytics" title="Link to this heading"></a></h2>
<p>Implement payment analytics and reporting:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PaymentAnalytics</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Payment analytics and reporting.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cardinity_client</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cardinity</span> <span class="o">=</span> <span class="n">cardinity_client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">payment_data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">collect_payment_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Collect payment data for analysis.&quot;&quot;&quot;</span>

        <span class="c1"># In production, this would fetch from your database</span>
        <span class="c1"># For demo, we&#39;ll simulate payment data</span>

        <span class="n">sample_payments</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;pay_001&#39;</span><span class="p">,</span>
                <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="mf">25.99</span><span class="p">,</span>
                <span class="s1">&#39;currency&#39;</span><span class="p">:</span> <span class="s1">&#39;EUR&#39;</span><span class="p">,</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;approved&#39;</span><span class="p">,</span>
                <span class="s1">&#39;created&#39;</span><span class="p">:</span> <span class="s1">&#39;2023-12-01T10:00:00Z&#39;</span><span class="p">,</span>
                <span class="s1">&#39;country&#39;</span><span class="p">:</span> <span class="s1">&#39;LT&#39;</span><span class="p">,</span>
                <span class="s1">&#39;card_brand&#39;</span><span class="p">:</span> <span class="s1">&#39;visa&#39;</span><span class="p">,</span>
                <span class="s1">&#39;payment_method&#39;</span><span class="p">:</span> <span class="s1">&#39;card&#39;</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;pay_002&#39;</span><span class="p">,</span>
                <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="mf">49.99</span><span class="p">,</span>
                <span class="s1">&#39;currency&#39;</span><span class="p">:</span> <span class="s1">&#39;EUR&#39;</span><span class="p">,</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;declined&#39;</span><span class="p">,</span>
                <span class="s1">&#39;created&#39;</span><span class="p">:</span> <span class="s1">&#39;2023-12-01T11:00:00Z&#39;</span><span class="p">,</span>
                <span class="s1">&#39;country&#39;</span><span class="p">:</span> <span class="s1">&#39;LV&#39;</span><span class="p">,</span>
                <span class="s1">&#39;card_brand&#39;</span><span class="p">:</span> <span class="s1">&#39;mastercard&#39;</span><span class="p">,</span>
                <span class="s1">&#39;payment_method&#39;</span><span class="p">:</span> <span class="s1">&#39;card&#39;</span>
            <span class="p">},</span>
            <span class="c1"># Add more sample data...</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">payment_data</span> <span class="o">=</span> <span class="n">sample_payments</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">payment_data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_payment_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate comprehensive payment report.&quot;&quot;&quot;</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collect_payment_data</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No payment data available&#39;</span><span class="p">}</span>

        <span class="c1"># Convert to DataFrame for analysis</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;created&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;created&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">])</span>

        <span class="c1"># Calculate metrics</span>
        <span class="n">total_transactions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">total_amount</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">approved_transactions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;approved&#39;</span><span class="p">])</span>
        <span class="n">approval_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">approved_transactions</span> <span class="o">/</span> <span class="n">total_transactions</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="c1"># Group by status</span>
        <span class="n">status_breakdown</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;count&#39;</span><span class="p">,</span>
            <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span>
        <span class="p">})</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="c1"># Group by country</span>
        <span class="n">country_breakdown</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;country&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;count&#39;</span><span class="p">,</span>
            <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span>
        <span class="p">})</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="c1"># Group by card brand</span>
        <span class="n">card_brand_breakdown</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;card_brand&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;count&#39;</span><span class="p">,</span>
            <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span>
        <span class="p">})</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="c1"># Daily trends</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;created&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
        <span class="n">daily_trends</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;count&#39;</span><span class="p">,</span>
            <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span>
        <span class="p">})</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="n">report</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;period&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;start&#39;</span><span class="p">:</span> <span class="n">start_date</span><span class="p">,</span>
                <span class="s1">&#39;end&#39;</span><span class="p">:</span> <span class="n">end_date</span>
            <span class="p">},</span>
            <span class="s1">&#39;summary&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;total_transactions&#39;</span><span class="p">:</span> <span class="n">total_transactions</span><span class="p">,</span>
                <span class="s1">&#39;total_amount&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">total_amount</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s1">&#39;approved_transactions&#39;</span><span class="p">:</span> <span class="n">approved_transactions</span><span class="p">,</span>
                <span class="s1">&#39;approval_rate&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">approval_rate</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s1">&#39;average_transaction&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">total_amount</span> <span class="o">/</span> <span class="n">total_transactions</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="p">},</span>
            <span class="s1">&#39;breakdowns&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;by_status&#39;</span><span class="p">:</span> <span class="n">status_breakdown</span><span class="p">,</span>
                <span class="s1">&#39;by_country&#39;</span><span class="p">:</span> <span class="n">country_breakdown</span><span class="p">,</span>
                <span class="s1">&#39;by_card_brand&#39;</span><span class="p">:</span> <span class="n">card_brand_breakdown</span>
            <span class="p">},</span>
            <span class="s1">&#39;trends&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;daily&#39;</span><span class="p">:</span> <span class="n">daily_trends</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">report</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fraud_detection_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Analyze payment patterns for fraud detection.&quot;&quot;&quot;</span>

        <span class="c1"># Implement fraud detection logic</span>
        <span class="n">suspicious_patterns</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Pattern 1: Multiple failed attempts from same IP</span>
        <span class="c1"># Pattern 2: Unusual geographic patterns</span>
        <span class="c1"># Pattern 3: High-value transactions outside normal hours</span>
        <span class="c1"># Pattern 4: Multiple different cards from same customer</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;suspicious_patterns&#39;</span><span class="p">:</span> <span class="n">suspicious_patterns</span><span class="p">,</span>
            <span class="s1">&#39;recommendations&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s1">&#39;Review high-risk transactions manually&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Implement additional verification for suspicious patterns&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Monitor geographic transaction patterns&#39;</span>
            <span class="p">]</span>
        <span class="p">}</span>
</pre></div>
</div>
</section>
<section id="complex-payment-workflows">
<h2>Complex Payment Workflows<a class="headerlink" href="#complex-payment-workflows" title="Link to this heading"></a></h2>
<p>Implement complex multi-step payment workflows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">PaymentWorkflowEngine</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Engine for complex payment workflows.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cardinity_client</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cardinity</span> <span class="o">=</span> <span class="n">cardinity_client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workflows</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_split_payment_workflow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">total_amount</span><span class="p">,</span> <span class="n">split_config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create workflow for split payments (marketplace scenario).&quot;&quot;&quot;</span>

        <span class="n">workflow_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;split_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">workflow</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">workflow_id</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;split_payment&#39;</span><span class="p">,</span>
            <span class="s1">&#39;total_amount&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">total_amount</span><span class="p">),</span>
            <span class="s1">&#39;splits&#39;</span><span class="p">:</span> <span class="n">split_config</span><span class="p">,</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;pending&#39;</span><span class="p">,</span>
            <span class="s1">&#39;payments&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;created&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">workflows</span><span class="p">[</span><span class="n">workflow_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">workflow</span>

        <span class="k">return</span> <span class="n">workflow_id</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">execute_split_payment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workflow_id</span><span class="p">,</span> <span class="n">payment_instrument</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute split payment workflow.&quot;&quot;&quot;</span>

        <span class="n">workflow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflows</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">workflow_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">workflow</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Workflow not found&#39;</span><span class="p">}</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Process each split</span>
        <span class="k">for</span> <span class="n">split</span> <span class="ow">in</span> <span class="n">workflow</span><span class="p">[</span><span class="s1">&#39;splits&#39;</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">payment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardinity</span><span class="o">.</span><span class="n">create_payment</span><span class="p">(</span>
                    <span class="n">amount</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]),</span>
                    <span class="n">currency</span><span class="o">=</span><span class="s1">&#39;EUR&#39;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Split payment - </span><span class="si">{</span><span class="n">split</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">country</span><span class="o">=</span><span class="s1">&#39;LT&#39;</span><span class="p">,</span>
                    <span class="n">order_id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">workflow_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">split</span><span class="p">[</span><span class="s1">&#39;recipient&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">payment_instrument</span><span class="o">=</span><span class="n">payment_instrument</span>
                <span class="p">)</span>

                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;recipient&#39;</span><span class="p">:</span> <span class="n">split</span><span class="p">[</span><span class="s1">&#39;recipient&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">split</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;payment_id&#39;</span><span class="p">:</span> <span class="n">payment</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">payment</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span>
                <span class="p">})</span>

                <span class="n">workflow</span><span class="p">[</span><span class="s1">&#39;payments&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">payment</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;recipient&#39;</span><span class="p">:</span> <span class="n">split</span><span class="p">[</span><span class="s1">&#39;recipient&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">split</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;payment_id&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;failed&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="p">})</span>

        <span class="c1"># Update workflow status</span>
        <span class="n">successful_payments</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;approved&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">successful_payments</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">workflow</span><span class="p">[</span><span class="s1">&#39;splits&#39;</span><span class="p">]):</span>
            <span class="n">workflow</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;completed&#39;</span>
        <span class="k">elif</span> <span class="n">successful_payments</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">workflow</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;partial&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">workflow</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;failed&#39;</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;workflow_id&#39;</span><span class="p">:</span> <span class="n">workflow_id</span><span class="p">,</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">workflow</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">],</span>
            <span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">results</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_subscription_with_trial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trial_period_days</span><span class="p">,</span> <span class="n">subscription_amount</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create subscription workflow with trial period.&quot;&quot;&quot;</span>

        <span class="n">workflow_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;trial_sub_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">workflow</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">workflow_id</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;trial_subscription&#39;</span><span class="p">,</span>
            <span class="s1">&#39;trial_period_days&#39;</span><span class="p">:</span> <span class="n">trial_period_days</span><span class="p">,</span>
            <span class="s1">&#39;subscription_amount&#39;</span><span class="p">:</span> <span class="n">subscription_amount</span><span class="p">,</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;trial_active&#39;</span><span class="p">,</span>
            <span class="s1">&#39;trial_start&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;trial_end&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">trial_period_days</span><span class="p">))</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;payments&#39;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">workflows</span><span class="p">[</span><span class="n">workflow_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">workflow</span>

        <span class="k">return</span> <span class="n">workflow_id</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">convert_trial_to_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workflow_id</span><span class="p">,</span> <span class="n">payment_instrument</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert trial to paid subscription.&quot;&quot;&quot;</span>

        <span class="n">workflow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflows</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">workflow_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">workflow</span> <span class="ow">or</span> <span class="n">workflow</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;trial_subscription&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid trial workflow&#39;</span><span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Create initial subscription payment</span>
            <span class="n">payment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardinity</span><span class="o">.</span><span class="n">create_payment</span><span class="p">(</span>
                <span class="n">amount</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">workflow</span><span class="p">[</span><span class="s1">&#39;subscription_amount&#39;</span><span class="p">]),</span>
                <span class="n">currency</span><span class="o">=</span><span class="s1">&#39;EUR&#39;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Trial conversion - First subscription payment&#39;</span><span class="p">,</span>
                <span class="n">country</span><span class="o">=</span><span class="s1">&#39;LT&#39;</span><span class="p">,</span>
                <span class="n">payment_instrument</span><span class="o">=</span><span class="n">payment_instrument</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">payment</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;approved&#39;</span><span class="p">:</span>
                <span class="n">workflow</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;subscription_active&#39;</span>
                <span class="n">workflow</span><span class="p">[</span><span class="s1">&#39;subscription_payment_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">payment</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                <span class="n">workflow</span><span class="p">[</span><span class="s1">&#39;payments&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">payment</span><span class="p">)</span>

                <span class="k">return</span> <span class="p">{</span>
                    <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s1">&#39;workflow_id&#39;</span><span class="p">:</span> <span class="n">workflow_id</span><span class="p">,</span>
                    <span class="s1">&#39;payment_id&#39;</span><span class="p">:</span> <span class="n">payment</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;subscription_active&#39;</span>
                <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">workflow</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;conversion_failed&#39;</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;workflow_id&#39;</span><span class="p">:</span> <span class="n">workflow_id</span><span class="p">,</span>
                    <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Payment failed&#39;</span>
                <span class="p">}</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">workflow</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;conversion_failed&#39;</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;workflow_id&#39;</span><span class="p">:</span> <span class="n">workflow_id</span><span class="p">,</span>
                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="p">}</span>
</pre></div>
</div>
</section>
<section id="advanced-security-features">
<h2>Advanced Security Features<a class="headerlink" href="#advanced-security-features" title="Link to this heading"></a></h2>
<p>Implement advanced security patterns:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.fernet</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fernet</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PaymentSecurity</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Advanced security features for payment processing.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encryption_key</span> <span class="o">=</span> <span class="n">Fernet</span><span class="o">.</span><span class="n">generate_key</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">Fernet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encryption_key</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">tokenize_payment_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payment_instrument</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tokenize sensitive payment data.&quot;&quot;&quot;</span>

        <span class="c1"># Generate unique token</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

        <span class="c1"># Encrypt payment data</span>
        <span class="n">encrypted_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payment_instrument</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># Store mapping (in production, use secure storage)</span>
        <span class="c1"># self.token_store[token] = encrypted_data</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;token&#39;</span><span class="p">:</span> <span class="n">token</span><span class="p">,</span>
            <span class="s1">&#39;encrypted_data&#39;</span><span class="p">:</span> <span class="n">encrypted_data</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span>
            <span class="s1">&#39;last_four&#39;</span><span class="p">:</span> <span class="n">payment_instrument</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pan&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="k">if</span> <span class="n">payment_instrument</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pan&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;card_brand&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect_card_brand</span><span class="p">(</span><span class="n">payment_instrument</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pan&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">detokenize_payment_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">encrypted_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decrypt tokenized payment data.&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">decrypted_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cipher</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">encrypted_data</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
            <span class="n">payment_instrument</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">decrypted_data</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">payment_instrument</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detokenization failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_detect_card_brand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pan</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Detect card brand from PAN.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">pan</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">pan</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;unknown&#39;</span>

        <span class="n">first_four</span> <span class="o">=</span> <span class="n">pan</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">first_four</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;4&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;visa&#39;</span>
        <span class="k">elif</span> <span class="n">first_four</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s1">&#39;51&#39;</span><span class="p">,</span> <span class="s1">&#39;52&#39;</span><span class="p">,</span> <span class="s1">&#39;53&#39;</span><span class="p">,</span> <span class="s1">&#39;54&#39;</span><span class="p">,</span> <span class="s1">&#39;55&#39;</span><span class="p">)):</span>
            <span class="k">return</span> <span class="s1">&#39;mastercard&#39;</span>
        <span class="k">elif</span> <span class="n">first_four</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s1">&#39;34&#39;</span><span class="p">,</span> <span class="s1">&#39;37&#39;</span><span class="p">)):</span>
            <span class="k">return</span> <span class="s1">&#39;amex&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;unknown&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_payment_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payment_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate hash for payment integrity verification.&quot;&quot;&quot;</span>

        <span class="c1"># Create canonical string from payment data</span>
        <span class="n">canonical_string</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">payment_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;amount&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">payment_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;currency&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">payment_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">payment_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;order_id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="p">])</span>

        <span class="c1"># Generate hash</span>
        <span class="n">payment_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">canonical_string</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">payment_hash</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">verify_payment_integrity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payment_data</span><span class="p">,</span> <span class="n">expected_hash</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verify payment data integrity.&quot;&quot;&quot;</span>

        <span class="n">calculated_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_payment_hash</span><span class="p">(</span><span class="n">payment_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">calculated_hash</span> <span class="o">==</span> <span class="n">expected_hash</span>
</pre></div>
</div>
</section>
<section id="integration-testing">
<h2>Integration Testing<a class="headerlink" href="#integration-testing" title="Link to this heading"></a></h2>
<p>Comprehensive integration testing:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">unittest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">patch</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AdvancedIntegrationTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Advanced integration tests for payment workflows.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cardinity</span> <span class="o">=</span> <span class="n">Cardinity</span><span class="p">(</span>
            <span class="n">consumer_key</span><span class="o">=</span><span class="s2">&quot;test_key&quot;</span><span class="p">,</span>
            <span class="n">consumer_secret</span><span class="o">=</span><span class="s2">&quot;test_secret&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_complete_payment_workflow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test complete payment workflow from creation to webhook.&quot;&quot;&quot;</span>

        <span class="c1"># Mock payment creation</span>
        <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cardinity</span><span class="p">,</span> <span class="s1">&#39;create_payment&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_create</span><span class="p">:</span>
            <span class="n">mock_create</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;test_payment_123&#39;</span><span class="p">,</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;approved&#39;</span><span class="p">,</span>
                <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="s1">&#39;25.99&#39;</span><span class="p">,</span>
                <span class="s1">&#39;currency&#39;</span><span class="p">:</span> <span class="s1">&#39;EUR&#39;</span>
            <span class="p">}</span>

            <span class="c1"># Create payment</span>
            <span class="n">payment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardinity</span><span class="o">.</span><span class="n">create_payment</span><span class="p">(</span>
                <span class="n">amount</span><span class="o">=</span><span class="s1">&#39;25.99&#39;</span><span class="p">,</span>
                <span class="n">currency</span><span class="o">=</span><span class="s1">&#39;EUR&#39;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Test payment&#39;</span><span class="p">,</span>
                <span class="n">country</span><span class="o">=</span><span class="s1">&#39;LT&#39;</span><span class="p">,</span>
                <span class="n">payment_instrument</span><span class="o">=</span><span class="p">{</span>
                    <span class="s1">&#39;pan&#39;</span><span class="p">:</span> <span class="s1">&#39;4111111111111111&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;exp_month&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
                    <span class="s1">&#39;exp_year&#39;</span><span class="p">:</span> <span class="mi">2025</span><span class="p">,</span>
                    <span class="s1">&#39;cvc&#39;</span><span class="p">:</span> <span class="s1">&#39;123&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;holder&#39;</span><span class="p">:</span> <span class="s1">&#39;Test User&#39;</span>
                <span class="p">}</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">payment</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">],</span> <span class="s1">&#39;approved&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">payment</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">],</span> <span class="s1">&#39;25.99&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_error_handling_workflow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test error handling in payment workflows.&quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cardinity</span><span class="p">,</span> <span class="s1">&#39;create_payment&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_create</span><span class="p">:</span>
            <span class="n">mock_create</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Invalid amount&quot;</span><span class="p">)</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">ValidationError</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cardinity</span><span class="o">.</span><span class="n">create_payment</span><span class="p">(</span>
                    <span class="n">amount</span><span class="o">=</span><span class="s1">&#39;invalid&#39;</span><span class="p">,</span>
                    <span class="n">currency</span><span class="o">=</span><span class="s1">&#39;EUR&#39;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Test&#39;</span><span class="p">,</span>
                    <span class="n">country</span><span class="o">=</span><span class="s1">&#39;LT&#39;</span><span class="p">,</span>
                    <span class="n">payment_instrument</span><span class="o">=</span><span class="p">{</span>
                        <span class="s1">&#39;pan&#39;</span><span class="p">:</span> <span class="s1">&#39;4111111111111111&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;exp_month&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
                        <span class="s1">&#39;exp_year&#39;</span><span class="p">:</span> <span class="mi">2025</span><span class="p">,</span>
                        <span class="s1">&#39;cvc&#39;</span><span class="p">:</span> <span class="s1">&#39;123&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;holder&#39;</span><span class="p">:</span> <span class="s1">&#39;Test User&#39;</span>
                    <span class="p">}</span>
                <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_webhook_processing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test webhook processing workflow.&quot;&quot;&quot;</span>

        <span class="n">webhook_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;payment.approved&#39;</span><span class="p">,</span>
            <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;test_payment_123&#39;</span><span class="p">,</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;approved&#39;</span><span class="p">,</span>
                <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="s1">&#39;25.99&#39;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1"># Test webhook handling</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;your_module.handle_payment_approved&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_handler</span><span class="p">:</span>
            <span class="n">handle_cardinity_webhook</span><span class="p">(</span><span class="n">webhook_data</span><span class="p">)</span>
            <span class="n">mock_handler</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="performance-optimization">
<h2>Performance Optimization<a class="headerlink" href="#performance-optimization" title="Link to this heading"></a></h2>
<p>Optimize payment processing performance:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">aiohttp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cachetools</span><span class="w"> </span><span class="kn">import</span> <span class="n">TTLCache</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PerformanceOptimizedPayments</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Performance-optimized payment processing.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">TTLCache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>  <span class="c1"># 5-minute cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_payment_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payment_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Asynchronous payment creation.&quot;&quot;&quot;</span>

        <span class="c1"># Check cache first</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_cache_key</span><span class="p">(</span><span class="n">payment_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cache_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span>

        <span class="c1"># Create payment asynchronously</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s1">&#39;https://api.cardinity.com/v1/payments&#39;</span><span class="p">,</span>
            <span class="n">json</span><span class="o">=</span><span class="n">payment_data</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_auth_headers</span><span class="p">()</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

            <span class="c1"># Cache successful results</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;approved&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>

            <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_cache_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payment_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate cache key for payment data.&quot;&quot;&quot;</span>

        <span class="c1"># Use order_id as cache key if available</span>
        <span class="k">return</span> <span class="n">payment_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;order_id&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">payment_data</span><span class="p">))))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_auth_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get authentication headers.&quot;&quot;&quot;</span>

        <span class="c1"># Implement OAuth or API key authentication</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="s1">&#39;Bearer your_token_here&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span>
        <span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">bulk_payment_processing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payment_requests</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process multiple payments concurrently.&quot;&quot;&quot;</span>

        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">payment_request</span> <span class="ow">in</span> <span class="n">payment_requests</span><span class="p">:</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_payment_async</span><span class="p">(</span><span class="n">payment_request</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">,</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>
</pre></div>
</div>
</section>
<section id="production-deployment">
<h2>Production Deployment<a class="headerlink" href="#production-deployment" title="Link to this heading"></a></h2>
<p>Production deployment considerations:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Production Deployment Best Practices</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">production_deployment_checklist</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Production deployment checklist for advanced features.&quot;&quot;&quot;</span>

    <span class="n">checklist</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Security&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">&#39;Use HTTPS for all communications&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Implement proper API key management&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Set up webhook signature verification&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Enable rate limiting&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Implement IP whitelisting where appropriate&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Use environment variables for secrets&#39;</span>
        <span class="p">],</span>
        <span class="s1">&#39;Monitoring&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">&#39;Set up payment processing metrics&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Implement error rate monitoring&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Configure performance monitoring&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Set up webhook delivery monitoring&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Create alerting for failed payments&#39;</span>
        <span class="p">],</span>
        <span class="s1">&#39;Scalability&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">&#39;Implement connection pooling&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Set up load balancing&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Configure auto-scaling&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Implement caching strategies&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Optimize database queries&#39;</span>
        <span class="p">],</span>
        <span class="s1">&#39;Reliability&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">&#39;Implement circuit breaker pattern&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Set up retry mechanisms&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Configure graceful degradation&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Implement health checks&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Set up backup payment methods&#39;</span>
        <span class="p">],</span>
        <span class="s1">&#39;Compliance&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">&#39;Ensure PCI DSS compliance&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Implement PSD2 requirements&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Set up audit logging&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Configure data retention policies&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Implement GDPR compliance&#39;</span>
        <span class="p">]</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">checklist</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ☐ </span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Link to this heading"></a></h2>
<p>After implementing advanced features:</p>
<ol class="arabic simple">
<li><p><strong>Performance Monitoring</strong>: Set up comprehensive monitoring and alerting</p></li>
<li><p><strong>Security Audit</strong>: Regular security audits and penetration testing</p></li>
<li><p><strong>Compliance Review</strong>: Ensure ongoing compliance with regulations</p></li>
<li><p><strong>Feature Enhancement</strong>: Continuously improve based on usage patterns</p></li>
<li><p><strong>Documentation Updates</strong>: Keep documentation current with new features</p></li>
<li><p><strong>Team Training</strong>: Train team members on advanced features and best practices</p></li>
</ol>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="error-handling.html" class="btn btn-neutral float-left" title="Error Handling" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../migration.html" class="btn btn-neutral float-right" title="Migration from Node.js SDK" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Cardinity.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>